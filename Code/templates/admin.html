<!DOCTYPE html>
<html lang="en">

<head>

    <!-------------------------------------------------------------------[ Google Fonts ]------------------------------------------------------------------------------>
    <link href='https://fonts.googleapis.com/css?family=Alata' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Londrina Sketch' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Poppins' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Nunito' rel='stylesheet'>
    <!------------------------------------------------------------------------------------------------------------------------------------------------------------------>

    <!-------------------------------------------------------------------[ Icon Link ]---------------------------------------------------------------------------------->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css">
    <!------------------------------------------------------------------------------------------------------------------------------------------------------------------->

    <!------------------------------------------------------------- [ Chart.js for analytics graphs] -------------------------------------------------------------------->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!------------------------------------------------------------------------------------------------------------------------------------------------------------------->

    <!-------------------------------------------------------------[ Css File ]------------------------------------------------------------------------------------------>
    <link rel="stylesheet" href="/static/admin.css">
    <!------------------------------------------------------------------------------------------------------------------------------------------------------------------->


    <title>Admin Panel</title>
   
</head>

<body>
    <div class="circle"></div> <!--yellow blur circle-->

    <div class="admin">

        <a href="{{ url_for('admin_dashboard') }}"><div class="header">StaRK AI Legal Bot <sub><a href="#" class="btn-shine">Admin</a></sub></div></a> <!--heading-->

        <div class="main">

            <div class="nav-bar"> <!--navigation side bar-->

                <ul>
                    <li>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#ffd900a6" width="20" height="20"> <!-- Dashboard Icon-->
                            <path
                                d="M14 21C13.4477 21 13 20.5523 13 20V12C13 11.4477 13.4477 11 14 11H20C20.5523 11 21 11.4477 21 12V20C21 20.5523 20.5523 21 20 21H14ZM4 13C3.44772 13 3 12.5523 3 12V4C3 3.44772 3.44772 3 4 3H10C10.5523 3 11 3.44772 11 4V12C11 12.5523 10.5523 13 10 13H4ZM9 11V5H5V11H9ZM4 21C3.44772 21 3 20.5523 3 20V16C3 15.4477 3.44772 15 4 15H10C10.5523 15 11 15.4477 11 16V20C11 20.5523 10.5523 21 10 21H4ZM5 19H9V17H5V19ZM15 19H19V13H15V19ZM13 4C13 3.44772 13.4477 3 14 3H20C20.5523 3 21 3.44772 21 4V8C21 8.55228 20.5523 9 20 9H14C13.4477 9 13 8.55228 13 8V4ZM15 5V7H19V5H15Z">
                            </path>
                        </svg> 
                        <a href="#dashboard"> Dashboard </a>
                    </li>
                    <li>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#ffd900a6" width="20" height="20"> <!-- User Icon-->
                            <path
                                d="M2 22C2 17.5817 5.58172 14 10 14C14.4183 14 18 17.5817 18 22H16C16 18.6863 13.3137 16 10 16C6.68629 16 4 18.6863 4 22H2ZM10 13C6.685 13 4 10.315 4 7C4 3.685 6.685 1 10 1C13.315 1 16 3.685 16 7C16 10.315 13.315 13 10 13ZM10 11C12.21 11 14 9.21 14 7C14 4.79 12.21 3 10 3C7.79 3 6 4.79 6 7C6 9.21 7.79 11 10 11ZM18.2837 14.7028C21.0644 15.9561 23 18.752 23 22H21C21 19.564 19.5483 17.4671 17.4628 16.5271L18.2837 14.7028ZM17.5962 3.41321C19.5944 4.23703 21 6.20361 21 8.5C21 11.3702 18.8042 13.7252 16 13.9776V11.9646C17.6967 11.7222 19 10.264 19 8.5C19 7.11935 18.2016 5.92603 17.041 5.35635L17.5962 3.41321Z">
                            </path>
                        </svg>
                        <a href="#user">Users</a>
                    </li>
                    <li>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#ffd900a6" width="20" class="m-10"> <!-- Inquiry Icon-->
                            <path
                                d="M17 2V4H20.0066C20.5552 4 21 4.44495 21 4.9934V21.0066C21 21.5552 20.5551 22 20.0066 22H3.9934C3.44476 22 3 21.5551 3 21.0066V4.9934C3 4.44476 3.44495 4 3.9934 4H7V2H17ZM7 6H5V20H19V6H17V8H7V6ZM9 16V18H7V16H9ZM9 13V15H7V13H9ZM9 10V12H7V10H9ZM15 4H9V6H15V4Z">
                            </path>
                        </svg>
                        <a href="#inquiry"> Inquiries</a>
                    </li>
                </ul>

                <div class="sidebar-footer-item" aria-label="Log out" onclick="logoutUser()"> 
                    <svg height="25" width="25" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#ffd900a6"> <!-- Logout Icon-->
                        <path
                            d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C15.2713 2 18.1757 3.57078 20.0002 5.99923L17.2909 5.99931C15.8807 4.75499 14.0285 4 12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C14.029 20 15.8816 19.2446 17.2919 17.9998L20.0009 17.9998C18.1765 20.4288 15.2717 22 12 22ZM19 16V13H11V11H19V8L24 12L19 16Z">
                        </path>
                    </svg>
                    <span class="log-out"><a href="#" class="logout-btn" onclick="logoutUser()">Logout</a></span>
                </div>

            </div>

            <div class="content">   <!--main content-->

                <div class="dashboard" id="dashboard">  <!--dashboard section-->

                    <div class="heading">DASHBOARD</div>

                    <div class="box">   
                        <div class="child" onclick="navigateToSection('user'); loadUsersByType('active')">  <!-- Active Users -->
                            <div class="sec-1" id="active-users-count"></div>
                            <div class="sec-2">Active Users</div>
                        </div>
                        <div class="child" onclick="navigateToSection('user'); loadUsersByType('total')">   <!-- Total Users -->
                            <div class="sec-1" id="total-users-count"></div>
                            <div class="sec-2">Total Users</div>
                        </div>
                        <div class="child" onclick="navigateToSection('user'); loadUsersByType('total')">   <!-- Total Chats -->
                            <div class="sec-1" id="total-chats-count"></div>
                            <div class="sec-2">Total Chats</div>
                        </div>
                        <div class="child" onclick="navigateToSection('user'); loadUsersByType('banned')">  <!-- Banned Users -->
                            <div class="sec-1" id="banned-users-count"></div>
                            <div class="sec-2">Banned Users</div>
                        </div>
                    </div>
                    
                    <div class="text">Analytics</div>
                    <div class="box-3">
                        <div class="analytics-grid">
                            <!-- User Activity Chart -->
                            <div class="analytics-card">
                                <h3>User Activity (Last 30 Days)</h3>
                                <div class="chart-container">
                                    <canvas id="userActivityChart"></canvas>
                                </div>
                            </div>
                            
                            <!-- Chat Distribution Chart -->
                            <div class="analytics-card">
                                <h3>Chat Categories</h3>
                                <div class="chart-container">
                                    <canvas id="chatCategoriesChart"></canvas>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>

                <div class="users" id="user">
                    <div class="heading">USERS</div>
                    <div class="box">
                        <div class="child-1">
                            <div class="box-1">
                                <div class="child" onclick="loadUsersByType('total'); highlightUserType('total')">
                                    <div class="sec-1" id="total-user"></div>
                                    <div class="sec-2">Total Users</div>
                                </div>
                                <div class="child" onclick="loadUsersByType('active'); highlightUserType('active')">
                                    <div class="sec-1" id="active-user"></div>
                                    <div class="sec-2">Active Users</div>
                                </div>
                                <div class="child" onclick="loadUsersByType('banned'); highlightUserType('banned')">
                                    <div class="sec-1" id="banned-user"></div>
                                    <div class="sec-2">Banned Users</div>
                                </div>
                            </div>
                            <div class="box-2">
                                <!-- User list will be loaded here dynamically -->
                                <div class="initial-message">Click on any user category above to view users</div>
                            </div>
                        </div>

                        <div class="child-2">
                            <!-- User's chat list will be loaded here dynamically -->
                            <div class="initial-message">Click on a user to view their conversations</div>
                        </div>
                    </div>

                </div>


                <div class="inquiry" id="inquiry">
                    <div class="heading">INQUIRES</div>
                    <div class="box">
                        <div class="inquiry-container" id="inquiriesContainer">
                            <div class="loading-message">Loading inquiries...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


        
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize charts when the page loads
            initializeCharts();
        });
        
        function initializeCharts() {
            // Chart 1: User Activity
            const userActivityCtx = document.getElementById('userActivityChart').getContext('2d');
            const userActivityChart = new Chart(userActivityCtx, {
                type: 'line',
                data: {
                    labels: generateDatesForLastMonth(),
                    datasets: [{
                        label: 'Active Users',
                        data: generateRandomData(30, 10, 50),
                        borderColor: 'gold',
                        backgroundColor: 'rgba(255, 217, 0, 0.1)',
                        tension: 0.2,
                        fill: true,
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#fff'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#fff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#fff',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        
            // Chart 2: Chat Categories
            const chatCategoriesCtx = document.getElementById('chatCategoriesChart').getContext('2d');
            const chatCategoriesChart = new Chart(chatCategoriesCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Contract Law', 'Family Law', 'Criminal Law', 'Property Law', 'Other'],
                    datasets: [{
                        data: [30, 25, 15, 20, 10],
                        backgroundColor: [
                            '#FFD900',
                            '#FF9A00',
                            '#FF6B6B',
                            '#4ECDC4',
                            '#7F7FD5'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#fff',
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        
            // Chart 3: Response Time
            const responseTimeCtx = document.getElementById('responseTimeChart').getContext('2d');
            const responseTimeChart = new Chart(responseTimeCtx, {
                type: 'bar',
                data: {
                    labels: ['January', 'February', 'March', 'April', 'May'],
                    datasets: [{
                        label: 'Average Response Time (seconds)',
                        data: [2.1, 1.8, 1.5, 1.3, 1.2],
                        backgroundColor: 'rgba(255, 217, 0, 0.7)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#fff'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#fff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#fff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        
            // Chart 4: User Retention
            const userRetentionCtx = document.getElementById('userRetentionChart').getContext('2d');
            const userRetentionChart = new Chart(userRetentionCtx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6'],
                    datasets: [{
                        label: 'Retention Rate (%)',
                        data: [100, 80, 65, 55, 48, 45],
                        borderColor: '#FFD900',
                        backgroundColor: 'transparent',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#fff'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: '#fff',
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#fff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }
        
        // Helper function to generate dates for the last month
        function generateDatesForLastMonth() {
            const dates = [];
            const today = new Date();
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(today.getDate() - i);
                dates.push(date.getDate() + '/' + (date.getMonth() + 1));
            }
            
            return dates;
        }
        
        // Helper function to generate random data
        function generateRandomData(count, min, max) {
            const data = [];
            for (let i = 0; i < count; i++) {
                data.push(Math.floor(Math.random() * (max - min + 1)) + min);
            }
            return data;
        }
        </script>
    <script>
        // ---------------------- USER MANAGEMENT FUNCTIONS ----------------------

        // Function to load user statistics
        function loadUserStats() {
            fetch('/admin/user_stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total-user').textContent = data.total_users;
                    document.getElementById('active-user').textContent = data.active_users;
                    document.getElementById('banned-user').textContent = data.banned_users;
                    
                    // Update dashboard counters too
                    document.getElementById('total-users-count').textContent = data.total_users;
                    document.getElementById('active-users-count').textContent = data.active_users;
                    document.getElementById('banned-users-count').textContent = data.banned_users;
                    
                    // Generate analytics charts with this data
                    generateUserActivityChart(data);
                })
                .catch(error => {
                    console.error('Error loading user stats:', error);
                });
        }
        
        // Function to handle logout
        function logoutUser(e) {
            if (e) e.preventDefault();
            // Send the actual logout request
            fetch('/admin/logout', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.ok || response.redirected) {
                    window.location.href = '/login'; // Redirect to login page
                } else {
                    throw new Error('Logout failed');
                }
            })
            .catch(error => {
                console.error('Logout error:', error);
                // Fallback to direct redirect if fetch fails
                window.location.href = '/login';
            });
            
            return false; // Prevent default behavior
        }
        
        // Function to load users by type (total, active, banned)
        function loadUsersByType(userType) {
            fetch(`/admin/users/${userType}`)
                .then(response => response.json())
                .then(data => {
                    const container = document.querySelector('.box-2');
                    container.innerHTML = ''; // Clear existing content

                    // Create title based on user type
                    const titleElement = document.createElement('div');
                    titleElement.className = 'user-list-title';
                    titleElement.textContent = userType.charAt(0).toUpperCase() + userType.slice(1) + ' Users';
                    container.appendChild(titleElement);

                    if (data.users.length === 0) {
                        const noUsersElement = document.createElement('div');
                        noUsersElement.className = 'no-users';
                        noUsersElement.textContent = 'No users found';
                        container.appendChild(noUsersElement);
                        return;
                    }

                    // Create user list
                    const userList = document.createElement('div');
                    userList.className = 'user-list';

                    data.users.forEach(user => {
                        const userElement = document.createElement('div');
                        userElement.className = 'user-item';
                        userElement.setAttribute('data-id', user._id);

                        userElement.innerHTML = `
                    <div class="user-info" onclick="loadUserChats('${user._id}')">
                        <span class="username">${user.username}</span>
                        <span class="user-ip">${user.last_ip || 'Unknown IP'}</span>
                    </div>
                    <div class="user-actions">
                        ${userType === 'banned' ?
                                `<button class="unban-btn" onclick="unbanUser('${user._id}')"><i class="ri-flag-2-line"></i></button>` :
                                `<button class="ban-btn" onclick="banUser('${user._id}')"><i class="ri-flag-2-fill"></i></button>`
                            }
                    </div>
                `;

                        userList.appendChild(userElement);
                    });

                    container.appendChild(userList);

                    // Mark the first user as active
                    const firstUser = container.querySelector('.user-item');
                    if (firstUser) {
                        firstUser.classList.add('active');
                        loadUserChats(firstUser.getAttribute('data-id'));
                    }

                    // Update dashboard counters
                    const userCount = data.users.length;

                    // Update in main dashboard
                    const dashboardCounters = document.querySelectorAll('#dashboard .box .child');
                    dashboardCounters.forEach(counter => {
                        const categoryText = counter.querySelector('.sec-2').textContent.trim();
                        if (categoryText.toLowerCase().includes(userType)) {
                            counter.querySelector('.sec-1').textContent = userCount;
                        }
                    });

                    // Update in user section box-1
                    if (userType === 'total') {
                        document.getElementById('total-user').textContent = userCount;
                    } else if (userType === 'active') {
                        document.getElementById('active-user').textContent = userCount;
                    } else if (userType === 'banned') {
                        document.getElementById('banned-user').textContent = userCount;
                    }
                })
                .catch(error => {
                    console.error(`Error loading ${userType} users:`, error);
                    const container = document.querySelector('.box-2');
                    container.innerHTML = `<div class="error-message">Error loading users</div>`;
                });
        }
        
        // Function to load all user counts on page load
        function loadAllUserCounts() {
            // Load counts for total, active, and banned users
            const userTypes = ['total', 'active', 'banned'];

            userTypes.forEach(type => {
                fetch(`/admin/users/${type}`)
                    .then(response => response.json())
                    .then(data => {
                        const count = data.users.length;

                        // Update in main dashboard
                        const dashboardCounters = document.querySelectorAll('#dashboard .box .child');
                        dashboardCounters.forEach(counter => {
                            const categoryText = counter.querySelector('.sec-2').textContent.trim();
                            if (categoryText.toLowerCase().includes(type)) {
                                counter.querySelector('.sec-1').textContent = count;
                            }
                        });

                        // Update in user section box-1
                        if (type === 'total') {
                            document.getElementById('total-user').textContent = count;
                            document.getElementById('total-users-count').textContent = count;
                        } else if (type === 'active') {
                            document.getElementById('active-user').textContent = count;
                            document.getElementById('active-users-count').textContent = count;
                        } else if (type === 'banned') {
                            document.getElementById('banned-user').textContent = count;
                            document.getElementById('banned-users-count').textContent = count;
                        }
                    })
                    .catch(error => {
                        console.error(`Error loading ${type} users count:`, error);
                    });
            });

            // Load total chats count if you have this endpoint
            fetch('/admin/chats/total')
                .then(response => response.json())
                .then(data => {
                    const count = data.count || 0;

                    // Update total chats count in dashboard
                    document.getElementById('total-chats-count').textContent = count;
                    
                    // Use this data for charts
                    fetchChatAnalytics();
                })
                .catch(error => {
                    console.error('Error loading total chats count:', error);
                });
        }

        // Call this function when the page loads
        document.addEventListener('DOMContentLoaded', function () {
            loadAllUserCounts();

            // Keep your original event listeners for clicking on user categories
        });
        // Function to load user chats
        function loadUserChats(userId) {
            // Highlight the selected user
            const userItems = document.querySelectorAll('.user-item');
            userItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-id') === userId) {
                    item.classList.add('active');
                }
            });

            fetch(`/admin/user/${userId}/chats`)
                .then(response => response.json())
                .then(data => {
                    const container = document.querySelector('.child-2');
                    container.innerHTML = ''; // Clear existing content

                    // Create title with username
                    const titleElement = document.createElement('div');
                    titleElement.className = 'chat-list-title';
                    titleElement.textContent = `${data.username}'s Conversations`;
                    container.appendChild(titleElement);

                    if (data.conversations.length === 0) {
                        const noChatsElement = document.createElement('div');
                        noChatsElement.className = 'no-chats';
                        noChatsElement.textContent = 'No conversations found';
                        container.appendChild(noChatsElement);
                        return;
                    }

                    // Create conversation list
                    const chatList = document.createElement('div');
                    chatList.className = 'chat-list';

                    data.conversations.forEach(conv => {
                        const convElement = document.createElement('div');
                        convElement.className = 'chat-item';
                        convElement.setAttribute('data-id', conv.conversation_id);

                        convElement.innerHTML = `
                        <div class="chat-info" onclick="viewFullConversation('${conv.conversation_id}')">
                            <span class="chat-date">${conv.created_at}</span>
                            <span class="chat-count">${conv.message_count} messages</span>
                        </div>
                        <div class="chat-preview" onclick="viewFullConversation('${conv.conversation_id}')">${conv.preview}</div>
                        <div class="chat-actions">
            
                            <button class="delete-chat-btn" onclick="deleteConversation('${conv.conversation_id}')">
                                <i class="ri-delete-bin-5-line"></i> 
                            </button>
                        </div>
                    `;

                        chatList.appendChild(convElement);
                    });

                    container.appendChild(chatList);
                })
                .catch(error => {
                    console.error('Error loading user chats:', error);
                    const container = document.querySelector('.child-2');
                    container.innerHTML = `<div class="error-message">Error loading conversations</div>`;
                });
        }

        // Function to view full conversation
        function viewFullConversation(convId) {
            fetch(`/admin/conversation/${convId}/messages`)
                .then(response => response.json())
                .then(data => {
                    const container = document.querySelector('.child-2');
                    container.innerHTML = ''; // Clear existing content

                    // Create back button and title
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'conversation-header';
                    headerDiv.innerHTML = `
                    <button class="back-btn" onclick="loadUserChats('${document.querySelector('.user-item.active')?.getAttribute('data-id')}')">
                        <i class="ri-arrow-left-line"></i> Back
                    </button>
                    <div class="conversation-title">Conversation from ${data.messages[0]?.timestamp || 'Unknown date'}</div>
                `;
                    container.appendChild(headerDiv);

                    // Create conversation messages container
                    const messagesContainer = document.createElement('div');
                    messagesContainer.className = 'conversation-messages';

                    // Add all messages
                    data.messages.forEach(msg => {
                        const messageElement = document.createElement('div');
                        messageElement.className = `message ${msg.is_bot ? 'bot-message' : 'user-message'}`;

                        messageElement.innerHTML = `
                        <div class="message-header">
                            <span class="message-username">${msg.username}</span>
                            <span class="message-time">${msg.timestamp}</span>
                        </div>
                        <div class="message-content">${msg.message}</div>
                    `;

                        messagesContainer.appendChild(messageElement);
                    });

                    container.appendChild(messagesContainer);
                })
                .catch(error => {
                    console.error('Error loading conversation:', error);
                    const container = document.querySelector('.child-2');
                    container.innerHTML = `
                    <div class="error-message">Error loading conversation</div>
                    <button class="back-btn" onclick="loadUserChats('${document.querySelector('.user-item.active')?.getAttribute('data-id')}')">
                        <i class="ri-arrow-left-line"></i> Back
                    </button>
                `;
                });
        }

        // Function to ban a user
        function banUser(userId) {
            if (confirm('Are you sure you want to ban this user?')) {
                fetch(`/admin/user/${userId}/ban`, {
                    method: 'POST'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(data.message);
                            // Reload current user type
                            const activeTab = document.querySelector('.sec-1.active');
                            if (activeTab) {
                                const userType = activeTab.id.replace('-user', '');
                                loadUsersByType(userType);
                            } else {
                                loadUsersByType('total');
                            }
                            // Reload stats
                            loadUserStats();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error banning user:', error);
                        alert('Error banning user');
                    });
            }
        }

        // Function to unban a user
        function unbanUser(userId) {
            fetch(`/admin/user/${userId}/unban`, {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert(data.message);
                        // Reload current user type
                        const activeTab = document.querySelector('.sec-1.active');
                        if (activeTab) {
                            const userType = activeTab.id.replace('-user', '');
                            loadUsersByType(userType);
                        } else {
                            loadUsersByType('banned');
                        }
                        // Reload stats
                        loadUserStats();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error unbanning user:', error);
                    alert('Error unbanning user');
                });
        }

        // Function to delete a conversation
        function deleteConversation(convId) {
            if (confirm('Are you sure you want to delete this conversation?')) {
                fetch(`/admin/conversation/${convId}`, {
                    method: 'DELETE'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Remove the conversation element from DOM
                            const convElement = document.querySelector(`.chat-item[data-id="${convId}"]`);
                            if (convElement) {
                                convElement.remove();
                            }

                            // Check if there are no more conversations
                            const convCount = document.querySelectorAll('.chat-item').length;
                            if (convCount === 0) {
                                const container = document.querySelector('.child-2');
                                const title = container.querySelector('.chat-list-title');
                                const noChatsElement = document.createElement('div');
                                noChatsElement.className = 'no-chats';
                                noChatsElement.textContent = 'No conversations found';
                                container.innerHTML = '';
                                container.appendChild(title);
                                container.appendChild(noChatsElement);
                            }

                            // Show alert
                            alert(data.message);
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting conversation:', error);
                        alert('Error deleting conversation');
                    });
            }
        }

        // Helper function to highlight the active user type
        function highlightUserType(type) {
            const userTypes = document.querySelectorAll('.sec-1');
            userTypes.forEach(element => {
                element.classList.remove('active');
            });
            document.getElementById(`${type}-user`).classList.add('active');
        }

        // ---------------------- INQUIRY MANAGEMENT FUNCTIONS ----------------------

        // Function to fetch and display inquiries
        function loadInquiries() {
            fetch('/admin/inquiries')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('inquiriesContainer');
                    container.innerHTML = ''; // Clear existing content

                    if (data.inquiries.length === 0) {
                        container.innerHTML = '<div class="no-inquiries">No inquiries found</div>';
                        return;
                    }

                    data.inquiries.forEach(inquiry => {
                        const inquiryElement = document.createElement('div');
                        inquiryElement.className = 'inquiry-item';
                        inquiryElement.setAttribute('data-id', inquiry._id);

                        // Add 'unread' class if inquiry is unread
                        if (inquiry.status === 'unread') {
                            inquiryElement.classList.add('unread');
                        }

                        inquiryElement.innerHTML = `
                        <div class="<div class="inquiry-header">
                            <div class="inquiry-actions">
                                ${inquiry.status === 'unread' ?
                                `<button class="mark-read-btn" onclick="markAsRead('${inquiry._id}')"><i class="ri-check-double-line"></i></button>` :
                                ''}
                                <button class="delete-btn" onclick="deleteInquiry('${inquiry._id}')"><i class="ri-delete-bin-5-line"></i> </button>
                                <pre class="inquiry-time">${inquiry.formatted_time.replace(' ', '  | ')}</pre>
                            </div>
                            
                        </div>
                        <div class="inquiry-info">
                            <p><strong>From:</strong> ${inquiry.name} (${inquiry.email})</p>
                            <p><strong>Subject:</strong> ${inquiry.subject}</p>
                        </div>
                        <div class="inquiry-message">
                            <p>${inquiry.message}</p>
                        </div>
                    `;

                        container.appendChild(inquiryElement);
                    });
                })
                .catch(error => {
                    console.error('Error loading inquiries:', error);
                    const container = document.getElementById('inquiriesContainer');
                    container.innerHTML = '<div class="error-message">Error loading inquiries</div>';
                });
        }

        // Function to mark inquiry as read
        function markAsRead(inquiryId) {
            fetch(`/admin/inquiries/${inquiryId}/mark_read`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Update UI directly without full reload
                        const inquiryElement = document.querySelector(`.inquiry-item[data-id="${inquiryId}"]`);
                        if (inquiryElement) {
                            inquiryElement.classList.remove('unread');
                            const markReadBtn = inquiryElement.querySelector('.mark-read-btn');
                            if (markReadBtn) {
                                markReadBtn.remove();
                            }
                        }
                    } else {
                        alert('Error marking inquiry as read');
                        loadInquiries(); // Fallback to full reload
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error marking inquiry as read');
                    loadInquiries(); // Fallback to full reload
                });
        }

        // Function to delete inquiry
        function deleteInquiry(inquiryId) {
            if (confirm('Are you sure you want to delete this inquiry?')) {
                fetch(`/admin/inquiries/${inquiryId}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Remove element from DOM without full reload
                            const inquiryElement = document.querySelector(`.inquiry-item[data-id="${inquiryId}"]`);
                            if (inquiryElement) {
                                inquiryElement.remove();
                            }

                            // Check if there are no more inquiries
                            const inquiryCount = document.querySelectorAll('.inquiry-item').length;
                            if (inquiryCount === 0) {
                                const container = document.getElementById('inquiriesContainer');
                                container.innerHTML = '<div class="no-inquiries">No inquiries found</div>';
                            }
                        } else {
                            alert('Error deleting inquiry');
                            loadInquiries(); // Fallback to full reload
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error deleting inquiry');
                        loadInquiries(); // Fallback to full reload
                    });
            }
        }

        // ---------------------- CHART FUNCTIONS ----------------------

        // Function to generate user activity chart
        function generateUserActivityChart(userData) {
            const ctx = document.getElementById('userActivityChart').getContext('2d');
            
            // If a chart already exists, destroy it
            if (window.userActivityChart) {
                window.userActivityChart.destroy();
            }
            
            // Create sample data for last 7 days (you'd replace this with real data)
            const dates = [];
            const activeUsersData = [];
            const newUsersData = [];
            
            // Generate last 7 days
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                dates.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                
                // Generate some random data
                activeUsersData.push(Math.floor(Math.random() * userData.active_users));
                newUsersData.push(Math.floor(Math.random() * 5)); // Random new users per day
            }
            
            window.userActivityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Active Users',
                            data: activeUsersData,
                            borderColor: '#ffd900',
                            backgroundColor: 'rgba(255, 217, 0, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'New Users',
                            data: newUsersData,
                            borderColor: '#00d9ff',
                            backgroundColor: 'rgba(0, 217, 255, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'User Activity (Last 7 Days)',
                            color: '#ffffff',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#ffffff'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#ffffff'
                            }
                        }
                    }
                }
            });
        }
        
        // Function to fetch chat analytics and create distribution chart
        function fetchChatAnalytics() {
            // In a real implementation, you'd fetch this data from your backend
            // For now, we'll create sample data
            
            const ctx = document.getElementById('messageDistributionChart').getContext('2d');
            
            // If a chart already exists, destroy it
            if (window.messageDistributionChart) {
                window.messageDistributionChart.destroy();
            }
            
            // Sample data for message distribution
            const categories = ['Legal Questions', 'Document Review', 'Contract Analysis', 'Legal Research', 'Other'];
            const messageData = [35, 25, 20, 15, 5]; // Percentages
            
            window.messageDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: messageData,
                        backgroundColor: [
                            '#ffd900',
                            '#00d9ff',
                            '#ff6b6b',
                            '#7bed9f',
                            '#a55eea'
                        ],
                        borderWidth: 2,
                        borderColor: 'rgba(255, 255, 255, 0.5)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Message Category Distribution',
                            color: '#ffffff',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#ffffff',
                                padding: 15
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        // ---------------------- NAVIGATION FUNCTIONS ----------------------

        // Function to handle navigation between sections
        function navigateToSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content > div').forEach(section => {
                section.style.display = 'none';
            });

            // Show the selected section
            document.getElementById(sectionId).style.display = 'block';

            // Update the active nav item
            document.querySelectorAll('.nav-bar a').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${sectionId}`) {
                    link.classList.add('active');
                }
            });

            // Scroll to top of the section
            document.querySelector('.content').scrollTop = 0;

            // Load section-specific data
            if (sectionId === 'dashboard') {
                loadUserStats();
                fetchChatAnalytics();
            } else if (sectionId === 'user') {
                loadUserStats();
                loadUsersByType('total');
                highlightUserType('total');
            } else if (sectionId === 'inquiry') {
                loadInquiries();
            }
        }

        // ---------------------- INITIALIZATION ----------------------

        // Initialize admin dashboard
        document.addEventListener('DOMContentLoaded', function () {
            // Set up navigation
            document.querySelectorAll('.nav-bar a').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const sectionId = this.getAttribute('href').substring(1);
                    navigateToSection(sectionId);
                });
            });

            // Add click event listeners to user counts
            document.getElementById('total-user').addEventListener('click', function () {
                loadUsersByType('total');
                highlightUserType('total');
            });

            document.getElementById('active-user').addEventListener('click', function () {
                loadUsersByType('active');
                highlightUserType('active');
            });

            document.getElementById('banned-user').addEventListener('click', function () {
                loadUsersByType('banned');
                highlightUserType('banned');
            });

            // Set up dashboard box click handlers
            document.querySelectorAll('#dashboard .box .child').forEach(box => {
                box.addEventListener('click', function() {
                    const categoryText = this.querySelector('.sec-2').textContent.trim().toLowerCase();
                    navigateToSection('user');
                    
                    if (categoryText.includes('active')) {
                        loadUsersByType('active');
                        highlightUserType('active');
                    } else if (categoryText.includes('total')) {
                        loadUsersByType('total');
                        highlightUserType('total');
                    } else if (categoryText.includes('banned')) {
                        loadUsersByType('banned');
                        highlightUserType('banned');
                    }
                });
            });

            // Initialize charts
            fetchChatAnalytics();

            // Navigate to dashboard by default
            navigateToSection('dashboard');

            // Set refresh intervals
            setInterval(loadUserStats, 30000);  // Refresh user stats every 30 seconds
            setInterval(function () {
                // Only refresh inquiries if the inquiry tab is active
                if (document.getElementById('inquiry').style.display !== 'none') {
                    loadInquiries();
                }
            }, 30000);  // Refresh inquiries every 30 seconds
        });
    </script>
</body>

</html>